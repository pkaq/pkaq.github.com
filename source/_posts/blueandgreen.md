---
title: 基于nginx的简易蓝绿发布
author: PKAQ
date: 2018-08-02 15:12:55
tags: ['DevOps','nginx','tomcat']
categories: ['DevOps']
---
  Blue/Green Deployment（蓝绿部署）,又称为`蓝绿发布`,是一种通过切换蓝绿环境的方式实现新版本的不停机发布手法.通过这种方式可以实现应用的不停机升级,快速回滚等诸多好处.当然弊端是切换的瞬间对于尚未来得及响应的请求会丢失响应.
  
  具体的做法是    
   - 1.部署两套生产环境,我们称这两套环境分别为`蓝色环境`和`绿色环境`.
   - 2.使用负载均衡指向其中一套环境(也可以都指向),当版本升级时 先将版本发布到备用环境中 ,进行有效性测试, 测试通过后,将需要升级的环境(如蓝色环境)流量全部导流到备用环境中,此时备用环境与原来的正式环境完成了一次角色互换.
   - 3.重新配置负载均衡.   
   - 4.如需回滚将LB流量重新指向旧环境即可.
  
  当然,这里也可以让蓝绿两套环境同时支持线上, 思路是一样的, 核心的技术点仍然是通过`nginx`配置热加载完成导流实现.
<!-- more -->   

# 1.环境准备   
  - nginx一份
  - tomcat两份(配置好端口并启动验证可访问)
 
# 2.LB配置   
  `nginx.conf`配置如下
  ```lua
  # ... 省略
  http {
  	# ... 前面省略
    upstream nginx_blue_green {
     	#蓝色环境
        #server 127.0.0.1:8081 down;
        #server 127.0.0.1:8080 weight=100;
        #绿色环境
        server 127.0.0.1:8080 down;
        server 127.0.0.1:8081 weight=100;
     }
     # ... 中间省略
	server {
		 location / {
       		 proxy_pass http://nginx_blue_green;
    	}
    }
    # ... 后面省略
}
  ```
# 3.发布切换   
  发布时只需要编辑`nginx.conf`注释解注对应蓝绿环境,然后使用`nginx -s reload`重新加载配置即可实现蓝绿切换.