<!DOCTYPE html>


  <html class="dark page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>CAS单点登陆(SSO)开发指南 | 如是我闻</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="cas,">
  

  <meta name="description" content="本教程使用的SSO服务器是Yelu大学研发的CAS(Central Authentication Server)，官网：http://www.jasig.org/cas下载地址:http://downloads.jasig.org/文档地址:http://jasig.github.io/cas/4.0.x/index.html本文修改的cas-server项目代码我已经放到了github上 htt">
<meta name="keywords" content="cas">
<meta property="og:type" content="article">
<meta property="og:title" content="CAS单点登陆(SSO)开发指南">
<meta property="og:url" content="https://pkaq.org/2015/01/14/2015-01-14-CAS/index.html">
<meta property="og:site_name" content="如是我闻">
<meta property="og:description" content="本教程使用的SSO服务器是Yelu大学研发的CAS(Central Authentication Server)，官网：http://www.jasig.org/cas下载地址:http://downloads.jasig.org/文档地址:http://jasig.github.io/cas/4.0.x/index.html本文修改的cas-server项目代码我已经放到了github上 htt">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2016-09-01T08:36:11.677Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CAS单点登陆(SSO)开发指南">
<meta name="twitter:description" content="本教程使用的SSO服务器是Yelu大学研发的CAS(Central Authentication Server)，官网：http://www.jasig.org/cas下载地址:http://downloads.jasig.org/文档地址:http://jasig.github.io/cas/4.0.x/index.html本文修改的cas-server项目代码我已经放到了github上 htt">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=d671a41f" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/fexo-theme.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?cd1f06c6f057506d537ab11e9f1693be";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  <link href="//cdn.webfont.youziku.com/webfonts/nomal/97080/42410/5865c4e5f629db00cc915895.css" rel="stylesheet" type="text/css">
 
</head>
</html>
<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">　</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">　</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE toolbox_color_0"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE toolbox_color_1"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE toolbox_color_2"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE toolbox_color_3"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE toolbox_color_4"
            href="/atom.xml"
            rel="noopener noreferrer"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE toolbox_color_5"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">环境配置#</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">目录#</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">#</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">#</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#null"><span class="toc-text">#</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#null"><span class="toc-text">#</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">#</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#null"><span class="toc-text">#</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#null"><span class="toc-text">#</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#null"><span class="toc-text">1.SSL配置#</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#null"><span class="toc-text">2.cas部署#</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">#</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">#</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-2015-01-14-CAS" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">CAS单点登陆(SSO)开发指南</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2015.01.14</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>PKAQ</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/SSO/">SSO</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
        <i class="icon-comment"></i> 
        共 <a class="ds-thread-count" id="uyan_count_unit" su="CAS单点登陆(SSO)开发指南" href="https://pkaq.org/2015/01/14/2015-01-14-CAS/index.html"></a>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>本教程使用的SSO服务器是Yelu大学研发的CAS(Central Authentication Server)，<br>官网：<a href="http://www.jasig.org/cas" target="_blank" rel="noopener">http://www.jasig.org/cas</a><br>下载地址:<a href="http://downloads.jasig.org/" target="_blank" rel="noopener">http://downloads.jasig.org/</a><br>文档地址:<a href="http://jasig.github.io/cas/4.0.x/index.html" target="_blank" rel="noopener">http://jasig.github.io/cas/4.0.x/index.html</a><br>本文修改的cas-server项目代码我已经放到了github上 <a href="https://github.com/pkaq/cas-server-3.5.2" target="_blank" rel="noopener">https://github.com/pkaq/cas-server-3.5.2</a></p>
<h3><span id="huan-jing-pei-zhi">环境配置</span><a href="#huan-jing-pei-zhi" class="header-anchor">#</a></h3><p>JDK:1.7.45<br>CAS版本:4.0.0</p>
<h2><span id="mu-lu">目录</span><a href="#mu-lu" class="header-anchor">#</a></h2><ol>
<li><a href="#env">环境准备</a><br><strong>_A.  <a href="#cert">证书生成</a><br>____</strong>1.  <a href="#export">导出证书</a><br><strong>__</strong>2.  <a href="#import">导入服务端信任证书</a><br><strong>__</strong>3.  <a href="#importclient">颁发给客户机</a><br><strong>_B.  <a href="#webserver">WEB服务器配置</a><br>____</strong>1.  <a href="#tomcat">tomcat配置</a><br><strong>__</strong>2.  <a href="#jboss">jboss配置</a><br><strong>__</strong>3.  <a href="#weblogic">webloigc配置</a><br><strong>__</strong>4.  <a href="#websphere">websphere配置</a></li>
<li><a href="#server">服务端搭建</a></li>
<li><a href="#client">客户端搭建</a><br>___a.  <a href="#withjava">JAVA客户端应用搭建</a></li>
<li><a href="#adv">进阶应用</a><br><strong>_a.  <a href="#adv_1">配置自定义校验规则</a><br>_</strong>b.  <a href="#adv_2">配置自定义认证返回参数</a><br>___c.  <a href="#adv_3">配置自定义界面</a></li>
</ol>
<a id="more"></a>
<h2><span id="yi-cas-huan-jing-zhun-bei"></span><a href="#yi-cas-huan-jing-zhun-bei" class="header-anchor">#</a></h2><h3><span id="a-zheng-shu-sheng-cheng"></span><a href="#a-zheng-shu-sheng-cheng" class="header-anchor">#</a></h3><p>用JDK自带的keytool工具生成证书：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">	keytool -genkey -alias wsria -keyalg RSA -keystore /home/mykey</span><br><span class="line">``` </span><br><span class="line"> 参数说明如图:  </span><br><span class="line"> ![生成秘钥](/images/2015/01/use-keytool-create-key.gif) </span><br><span class="line"></span><br><span class="line">p.s:</span><br><span class="line">1.也可以申请免费的startssl证书,具体申请过程请移步  </span><br><span class="line">https://www.startssl.com/?app=11&amp;action=regform  </span><br><span class="line">当然国内也有一家wosign可以申请,申请速度比startssl要快一些,而且在线客服态度很好可以提供很好的帮助  </span><br><span class="line">www.wosign.com  </span><br><span class="line"></span><br><span class="line">2.具体的输入项图片中都有说明，有一点我要解释一下；在输入完密码后提示输入域名是我输入的是sso.wsria.com，其实这个域名是不存在的，但是我为了演示所以虚拟了这个域名，技巧在于修改</span><br><span class="line"></span><br><span class="line">C:\Windows\System32\drivers\etc\hosts</span><br><span class="line">添加内容如下：</span><br><span class="line"></span><br><span class="line">127.0.0.1  sso.wsria.com</span><br><span class="line">这样在访问sso.wsria.com的时候其实是访问的127.0.0.1也就是本机</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>### &lt;a name="export"&gt;1.导出证书&lt;/a&gt;</span><br><span class="line">```shell</span><br><span class="line">	keytool -export -file /home/my.crt -alias wsria -keystore /home/mykey</span><br></pre></td></tr></table></figure></p>
<h4><span id="2-jia-ru-fu-wu-duan-xin-ren"></span><a href="#2-jia-ru-fu-wu-duan-xin-ren" class="header-anchor">#</a></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -trustcacerts -alias [keyEntry_name] -file mycert.crt -keystore [keystore_name]</span><br></pre></td></tr></table></figure>
<h4><span id="3-ban-fa-zheng-shu-gei-ke-hu-ji-bing-jia-ru-jdk-xin-ren"></span><a href="#3-ban-fa-zheng-shu-gei-ke-hu-ji-bing-jia-ru-jdk-xin-ren" class="header-anchor">#</a></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -file /opt/name.cer -keystore $JAVA_HOME/jre7/lib/security/cacerts -alias server</span><br></pre></td></tr></table></figure>
<p>这里默认密码是changeit</p>
<h3><span id="b-web-fu-wu-qi-pei-zhi"></span><a href="#b-web-fu-wu-qi-pei-zhi" class="header-anchor">#</a></h3><h5><span id="a-tomcat"></span><a href="#a-tomcat" class="header-anchor">#</a></h5><p>首先要启用Web服务器(Tomcat)的SSL，也就是HTTPS加密协议;<br>打开tomcat目录的conf/server.xml文件，找到如下行并设置keystoreFile、keystorePass修改结果如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8443"</span> <span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11Protocol"</span> <span class="attr">SSLEnabled</span>=<span class="string">"true"</span> <span class="attr">maxThreads</span>=<span class="string">"150"</span></span></span><br><span class="line"><span class="tag"><span class="attr">scheme</span>=<span class="string">"https"</span> <span class="attr">secure</span>=<span class="string">"true"</span> <span class="attr">clientAuth</span>=<span class="string">"false"</span> <span class="attr">sslProtocol</span>=<span class="string">"TLS"</span></span></span><br><span class="line"><span class="tag"><span class="attr">keystoreFile</span>=<span class="string">"/home/mykey"</span> <span class="attr">keystorePass</span>=<span class="string">"xxxx"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>参数说明:<br>keystoreFile：在第一步创建的key存放位置<br>keystorePass：创建证书时的密码</p>
<p>p.s<br>按同样的方法来配置Tomcat 7却启动不起来，报如下错误：</p>
<p>严重: Failed to initialize end point associated with ProtocolHandler [“http-apr-8443”]<br>java.lang.Exception: Connector attribute SSLCertificateFile must be defined when using SSL with APR</p>
<p>仔细看上面的异常信息发现这是APR报的错误。Tomcat 6也有APR包但我从来都没用过。为此查看了Tomcat的ssl-how，在“Edit the Tomcat Configuration File”一节中说到：<br>Tomcat提供了两个SSL实现，一个是JSSE实现，另一个是APR实现。<br>Tomcat将自动选择使用哪个实现，即如果安装了APR则自动选择APR，否则选择JSSE。<br>如果不希望让Tomcat自动选择，而是我们自己指定一个实现则可通过protocol定义，如下：</p>
<connector protocol="...">

<p>我又查看了6.0的相同说明，里面与7.0的说明一模一样。因此问题只可能是：是否安装了APR包。</p>
<p>以前只听说过APR但没弄过。APR是什么文件？后来才发现APR文件名为tcnative-1.dll。进一步检查6.0和7.0的安装目录，结果发现6.0里没这个dll文件，而7.0里有。换句话说，6.0默认使用JSSE实现，而7.0默认使用APR实现。</p>
<p>弄明白缘由就好办了。由于习惯使用6.0的配置方式（即JSEE实现），因此只要把上面conf\server.xml里的protocol修改一下就行了：</p>
<pre><code>&lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11Protocol&quot; SSLEnabled=&quot;true&quot;
           maxThreads=&quot;150&quot; scheme=&quot;https&quot; secure=&quot;true&quot;
           clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot;
           keystoreFile=&quot;${user.home}/.keystore&quot;
           keystorePass=&quot;changeit&quot; /&gt;
</code></pre><p>重新启动，一切正常。</p>
<h5><span id="b-jboss"></span><a href="#b-jboss" class="header-anchor">#</a></h5><h6><span id="1-ssl-pei-zhi">1.SSL配置</span><a href="#1-ssl-pei-zhi" class="header-anchor">#</a></h6><p>找到standalone-&gt;configuration-&gt;standalone.xml<br>修改<connector name="https" protocol="HTTP/1.1" scheme="https" socket-binding="https">节点为如下内容<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connector</span> <span class="attr">name</span>=<span class="string">"https"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">scheme</span>=<span class="string">"https"</span> <span class="attr">socket-binding</span>=<span class="string">"https"</span> <span class="attr">secure</span>=<span class="string">"true"</span> <span class="attr">enabled</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ssl</span> <span class="attr">name</span>=<span class="string">"https"</span> <span class="attr">key-alias</span>=<span class="string">"1"</span> <span class="attr">password</span>=<span class="string">"Masterfrank099"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">certificate-key-file</span>=<span class="string">"D:/key/domainname.jks"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">protocol</span>=<span class="string">"all"</span> <span class="attr">verify-client</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connector</span>&gt;</span></span><br></pre></td></tr></table></figure></connector></p>
<p>key-alias：证书别名<br>password：证书密码<br>certificate-key-file：证书放位置</p>
<p>p.s:JBOSS 4.2以上版本服务启动如果不加任何参数的话,只监听127.0.0.1,就是说只能用127.0.0.1或者localhost访问，用本机的对外地址是访问不了，同一网络内别的机子无法访问。</p>
<p>解决方案：打开jboss7/standalone/configuration/standalone.xml，找到如下代码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">name</span>=<span class="string">"public"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">inet-address</span> <span class="attr">value</span>=<span class="string">"$&#123;jboss.bind.address:127.0.0.1&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将127.0.0.1改为0.0.0.0即可解决jboss无法使用IP地址访问的问题。</p>
<h6><span id="2-cas-bu-shu">2.cas部署</span><a href="#2-cas-bu-shu" class="header-anchor">#</a></h6><p>1、将war包放到jboss7/standalone/ deployments目录下，启动jboss，如可正常访问，说明部署成功。<br>2、  若直接将car.war部署到jboss中，在启动时就会报错，引起错误的原因：<br>  1)  由于jboss自带有log4j日志，这就会引起jboss的log4j与cas的log4j发生冲突，将cas中引入log4j.xml的代码删除即可。<br>  2)  未指定hibernate的方言，打开cas.war\WEB-INF\classes\META-INF\ persistence.xml,将如下代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.dialect"</span><span class="attr">value</span>=<span class="string">"org.hibernate.dialect.HSQLDialect"</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">//放到</span><br><span class="line"><span class="tag">&lt;<span class="name">persistence-unit</span> <span class="attr">name</span>=<span class="string">"CasPersistence"</span> <span class="attr">transaction-type</span>=<span class="string">"RESOURCE_LOCAL"</span>&gt;</span>下。</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">##### <span class="tag">&lt;<span class="name">a</span> <span class="attr">name</span>=<span class="string">"weblogic"</span>&gt;</span>c.WebLogic<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">Weblogic默认端口为7001</span><br><span class="line">请移步:[\[weblogic 12c安装\] - ssl配置/cas部署](\2015\01\26\installweblogic\index.html)  </span><br><span class="line">p.s:</span><br><span class="line">1.官方提供的zip压缩版经测试无法正常访问ssl,可能少东西</span><br><span class="line">2.打成war包部署会报log4j.xml找不到错误,直接以目录形式部署没问题,出现该问题的原因应该是加载冲突所致,可考虑用serverlet方式加载spring的log4j listener</span><br><span class="line"></span><br><span class="line">#####<span class="tag">&lt;<span class="name">a</span> <span class="attr">name</span>=<span class="string">"websphere"</span>&gt;</span>d.WebSphere<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">Weblogic默认端口为9080</span><br><span class="line">请移步:[\[websphere 8.5.5安装\] - ssl配置/cas部署](\2015\01\27\websphereinstall\index.html)  </span><br><span class="line"></span><br><span class="line">## <span class="tag">&lt;<span class="name">a</span> <span class="attr">name</span>=<span class="string">"server"</span>&gt;</span>二、CAS服务端搭建<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	1.CAS服务端下载：http://www.jasig.org/cas/download</span><br><span class="line">	2.解压cas-server-xxx/modules/cas-server-webapp-xxx.war，改名为cas，然后复制cas目录到你的tomcat/webapp目录下</span><br><span class="line">	3.访问http://localhost:8080/cas即可看到项目首页,输入casuser/Mellon点击登录（这是4.0.x之后版本的用户名密码,3.5.x版本CAS默认的验证规则只要用户名和密码相同就通过）</span><br><span class="line">	所以如果你看到下面的这张图片你就成功了</span><br><span class="line">![登陆成功](/images/2015/01/cas-login-success.gif)</span><br><span class="line"></span><br><span class="line">## <span class="tag">&lt;<span class="name">a</span> <span class="attr">name</span>=<span class="string">"client"</span>&gt;</span>三、CAS客户端<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">### <span class="tag">&lt;<span class="name">a</span> <span class="attr">name</span>=<span class="string">"withjava"</span>&gt;</span>A.Java客户端集成<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">1.在客户端添加 "org.jasig.cas.client:cas-client-core:+",依赖</span><br><span class="line">2.配置客户端web.xml文件</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">  <span class="comment">&lt;!-- 单点登陆配置开始 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 用于单点退出，该过滤器用于实现单点登出功能，可选配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.jasig.cas.client.session.SingleSignOutHttpSessionListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 该过滤器用于实现单点登出功能，可选配置。 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Single Sign Out Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.session.SingleSignOutFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Single Sign Out Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 该过滤器负责用户的认证工作，必须启用它 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CASFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.authentication.AuthenticationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 服务器登陆页面url </span></span><br><span class="line"><span class="comment">       casServerUrlPrefix  参数的值是cas 服务的访问地址。cas client 验证ticket 的时候，</span></span><br><span class="line"><span class="comment">      要访问cas 服务的/serviceValidate 接口，使用的url 就是$&#123; casServerUrlPrefix &#125;serviceValidate ，</span></span><br><span class="line"><span class="comment">      因为客户web 应用要验证cas 的证书，所以证书cn 字段的值必须和casServerUrlPrefix 里设置的cas 服务器的域名保持一致，</span></span><br><span class="line"><span class="comment">      并且在web 应用的服务器上配置cas 服务的访问域名。 </span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerLoginUrl<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://www.sifenggu.com:8443/cas/login<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里的server是服务端的IP--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://localhost:9090<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CASFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 该过滤器负责对Ticket的校验工作，必须启用它 ,如果要从服务器获取用户名之外的更多信息应该采用cas20这个2.0协议的代理--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Validation Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.validation.Cas20ProxyReceivingTicketValidationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  casServerUrlPrefix  参数的值是cas 服务的访问地址。</span></span><br><span class="line"><span class="comment">          cas client 验证ticket 的时候，要访问cas 服务的/serviceValidate 接口，</span></span><br><span class="line"><span class="comment">          使用的url 就是$&#123; casServerUrlPrefix &#125;serviceValidate ，因为客户web 应用要验证cas 的证书，</span></span><br><span class="line"><span class="comment">          所以证书cn 字段的值必须和casServerUrlPrefix 里设置的cas 服务器的域名保持一致，并且在web 应用的服务器上配置cas 服务的访问域名。  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerUrlPrefix<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://www.sifenggu.com:8443/cas<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--serverName 参数，cas client 会用来生成service 参数，并且cas 服务器在认证通过、ticket 验证通过后，</span></span><br><span class="line"><span class="comment">      会redirect 到web 应用，redirect 的url 就是service 参数的值。serverName 参数可以是IP ，也可以是域名，只要保证浏览器能访问到即可。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://localhost:9090<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Validation Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  该过滤器负责实现HttpServletRequest请求的包裹，</span></span><br><span class="line"><span class="comment">  比如允许开发者通过HttpServletRequest的getRemoteUser()方法获得SSO登录用户的登录名，可选配置。</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS HttpServletRequest Wrapper Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.util.HttpServletRequestWrapperFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS HttpServletRequest Wrapper Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  该过滤器使得开发者可以通过org.jasig.cas.client.util.AssertionHolder来获取用户的登录名。</span></span><br><span class="line"><span class="comment">  比如AssertionHolder.getAssertion().getPrincipal().getName()。</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Assertion Thread Local Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.util.AssertionThreadLocalFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Assertion Thread Local Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 自动根据单点登录的结果设置本系统的用户信息 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>AutoSetUserAdapterFilter<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AutoSetUserAdapterFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>demo.frank.wu.sso.cas.AutoSetUserAdapterFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AutoSetUserAdapterFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 单点登陆配置结束 --&gt;</span></span><br><span class="line">  ```  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## <span class="tag">&lt;<span class="name">a</span> <span class="attr">name</span>=<span class="string">"adv"</span>&gt;</span>四、进阶应用<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">### <span class="tag">&lt;<span class="name">a</span> <span class="attr">name</span>=<span class="string">"adv_1"</span>&gt;</span>A.配置自定义校验规则<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">打开cas-server-webapp项目,找到src/main/webapp/WEB-INF/deployerConfigContext.xml,将primaryAuthenticationHandler这个bean注释掉,用如下bean替代</span><br><span class="line">```xml  </span><br><span class="line"><span class="comment">&lt;!-- 自定义数据库鉴权 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"primaryAuthenticationHandler"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.adaptors.jdbc.QueryDatabaseAuthenticationHandler"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"sql"</span>  <span class="attr">value</span>=<span class="string">"select upper(password) from itsm_user where loginname= ?"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"passwordEncoder"</span> <span class="attr">ref</span>=<span class="string">"MD5PasswordEncoder"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line">在其它位置配置数据源以及自定义加密的bean  </span><br><span class="line">```xml   </span><br><span class="line"><span class="comment">&lt;!-- datasource数据源,采用此数据源需要将druid和ojdbc依赖添加到项目中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"xxx"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"xxx"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:oracle:thin:@xxx.xxx.xxx.xx:1521:xxx"</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 配置初始化大小、最小、最大 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"120"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- MD5加密 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"MD5PasswordEncoder"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.util.MD5Encoder"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>关于自定义密码加密的MD5Encoder类,只要自己写一个类实现org.jasig.cas.authentication.handler.PasswordEncoder接口中的<br>  public String encode(String password)<br>方法即可,该方法的返回值是加密处理后的密码。 当然如果你用MD5加密可以采用内置的MD5PasswordEncoder;</p>
<p>修改完成后重新打包cas-server-webapp项目<br>P.S 1:连接数据库需要增加对cas-server-support-jdbc项目和数据源以及数据库驱动的依赖，关于如何向pom添加依赖，请自补；当然最好给根POM配置一下国内的maven库（例如开源中国的），否则不仅会很慢，很多依赖也无法下载。</p>
<p>2:由于Oracle的原因 maven库中并未提供oracle驱动，而maven又不像gradle那样可以简易友好的加载本地依赖，所以需要你找到oracle驱动并且 注 册 到 本 地 仓 库<br>mvn install:install-file -Dfile={Path/to/your/ojdbc.jar} -DgroupId=com.oracle -DartifactId=ojdbc6 -Dversion=11.2.0 -Dpackaging=jar</p>
<p>部署到tomcat之后便可以通过数据库中的正式用户进行登陆了.如果页面提示”您提供的凭证有误”多半为数据源配置或密码不匹配所致。建议检查数据源是否配置正确以及encoder加密返回的密码与数据库存储的加密密码（区分大小写）是否一致。</p>
<p>修改完成后采用mavenpackge命令或者直接再eclipse中执行maven install进行构建即可.</p>
<h3><span id="b-pei-zhi-zi-ding-yi-ren-zheng-fan-hui-can-shu"></span><a href="#b-pei-zhi-zi-ding-yi-ren-zheng-fan-hui-can-shu" class="header-anchor">#</a></h3><p>默认情况下cas认证完成后只会返回username给客户端,如果需要返回更多信息需要修改deployerConfigContext.xml文件，同时配置attributeRepository如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"attributeRepository"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">class</span>=<span class="string">"org.jasig.services.persondir.support.jdbc.SingleRowJdbcPersonAttributeDao"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--指定数据源--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--指定查询sql--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"select  username,loginname from ITSM_USER  where &#123;0&#125;"</span> /&gt;</span>  </span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 组装sql用的查询条件属性 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"queryAttributeMapping"</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">	        <span class="comment">&lt;!-- key必须是uername而且是小写否则会导致取不到用户的其它信息，value对应数据库用户名字段,系统会自己匹配 --&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"loginname"</span> /&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"resultAttributeMapping"</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">	        <span class="comment">&lt;!-- key为对应的数据库字段名称，value为提供给客户端获取的属性名字，系统会自动填充值 --&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"loginname"</span> <span class="attr">value</span>=<span class="string">"loginname"</span>/&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceRegistryDao"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.InMemoryServiceRegistryDaoImpl"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"registeredServices"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.RegexRegisteredService"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"HTTP and IMAP"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">value</span>=<span class="string">"Allows HTTP(S) and IMAP(S) protocols"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceId"</span> <span class="attr">value</span>=<span class="string">"^(https?|imaps?)://.*"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"evaluationOrder"</span> <span class="attr">value</span>=<span class="string">"10000001"</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 此属性相当关键,必须配置后客户端才能获取信息 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"allowedAttributes"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">			        <span class="tag">&lt;<span class="name">value</span>&gt;</span>username<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">			        <span class="tag">&lt;<span class="name">value</span>&gt;</span>loginname<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">			    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>找到casServiceValidationSuccess.jsp。此文件作用是在server验证成功后，这个页面负责生成与客户端交互的xml信息，在默认的casServiceValidationSuccess.jsp中，只包括用户登录名，并不提供其他的属性信息，因此需要对页面进行扩展。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page session=<span class="string">"false"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span><br><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jsp/jstl/functions"</span> prefix=<span class="string">"fn"</span> %&gt;</span><br><span class="line">&lt;cas:serviceResponse xmlns:cas=<span class="string">'http://www.yale.edu/tp/cas'</span>&gt;</span><br><span class="line">	&lt;cas:authenticationSuccess&gt;</span><br><span class="line">		&lt;cas:user&gt;$&#123;fn:escapeXml(assertion.chainedAuthentications[fn:length(assertion.chainedAuthentications)-1].principal.id)&#125;&lt;/cas:user&gt;</span><br><span class="line">		&lt;c:<span class="keyword">if</span> test=<span class="string">"$&#123;not empty pgtIou&#125;"</span>&gt;</span><br><span class="line">			&lt;cas:proxyGrantingTicket&gt;$&#123;pgtIou&#125;&lt;/cas:proxyGrantingTicket&gt;</span><br><span class="line">		&lt;/c:if&gt;</span><br><span class="line">		&lt;c:<span class="keyword">if</span> test=<span class="string">"$&#123;fn:length(assertion.chainedAuthentications) &gt; 1&#125;"</span>&gt;</span><br><span class="line">			&lt;cas:proxies&gt;</span><br><span class="line">				&lt;c:forEach <span class="keyword">var</span>=<span class="string">"proxy"</span> items=<span class="string">"$&#123;assertion.chainedAuthentications&#125;"</span> varStatus=<span class="string">"loopStatus"</span> begin=<span class="string">"0"</span> end=<span class="string">"$&#123;fn:length(assertion.chainedAuthentications)-2&#125;"</span> step=<span class="string">"1"</span>&gt;</span><br><span class="line">					&lt;cas:proxy&gt;$&#123;fn:escapeXml(proxy.principal.id)&#125;&lt;/cas:proxy&gt;</span><br><span class="line">				&lt;/c:forEach&gt;</span><br><span class="line">			&lt;/cas:proxies&gt;</span><br><span class="line">		&lt;/c:if&gt;</span><br><span class="line">	   &lt;!-- 在server验证成功后，这个页面负责生成与客户端交互的xml信息，在默认的casServiceValidationSuccess.jsp中，只包括用户名，并不提供其他的属性信息，因此需要对页面进行扩展 --&gt;  </span><br><span class="line">       &lt;c:<span class="keyword">if</span>  test=<span class="string">"$&#123;fn:length(assertion.chainedAuthentications[fn:length(assertion.chainedAuthentications)-1].principal.attributes) &gt; 0&#125;"</span>&gt;</span><br><span class="line">	        &lt;cas:attributes&gt;</span><br><span class="line">	            &lt;c:forEach <span class="keyword">var</span>=<span class="string">"attr"</span></span><br><span class="line">	               items=<span class="string">"$&#123;assertion.chainedAuthentications[fn:length(assertion.chainedAuthentications)-1].principal.attributes&#125;"</span>&gt;</span><br><span class="line">	                &lt;cas:$&#123;fn:escapeXml(attr.key)&#125;&gt;$&#123;fn:escapeXml(attr.value)&#125;&lt;/cas:$&#123;fn:escapeXml(attr.key)&#125;&gt;</span><br><span class="line">	            &lt;/c:forEach&gt;</span><br><span class="line">	        &lt;/cas:attributes&gt;</span><br><span class="line">   		&lt;/c:if&gt;</span><br><span class="line">	&lt;/cas:authenticationSuccess&gt;</span><br><span class="line">&lt;/cas:serviceResponse&gt;</span><br></pre></td></tr></table></figure>
<p>客户端获取用户信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AttributePrincipal principal = (AttributePrincipal) request.getUserPrincipal();</span><br><span class="line">String loginName = principal.getName();</span><br><span class="line">System.out.println(<span class="string">"loginName:"</span> + loginName);</span><br><span class="line">Map&lt;String, Object&gt; attributes = principal.getAttributes();</span><br><span class="line">System.out.println(<span class="string">"username:"</span> + attributes.get(<span class="string">"username"</span>));</span><br></pre></td></tr></table></figure></p>
<h3><span id="c-cas-jie-mian-xiu-gai"></span><a href="#c-cas-jie-mian-xiu-gai" class="header-anchor">#</a></h3><p>1.cas统一认证的登陆页面位于：cas目录/WEB-INF/view/jsp/default 文件夹里，其中ui/casLoginView.jsp为登陆页面</p>
<p>2.首先复制一份default文件夹 重命名为myview</p>
<p>3.然后复制classes/default.properties  到 classes/mytheme.properties 打开mytheme.properties 修改登陆页面的路径为我们复制的myview 文件夹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## 修改登陆页面为自定义页面</span><br><span class="line">## mod by wuf 2015/1/16</span><br><span class="line">casLoginView.url=/WEB-INF/view/jsp/myview/ui/casLoginView.jsp</span><br></pre></td></tr></table></figure>
<p>4 修改 cas目录/cas.properties 中 cas.viewResolver.basename =mytheme</p>
<p>到这一步我们只是将登陆页面拷贝了一份然后指向这份拷贝，接下来我们就可以随意修改我们拷贝的页面，这样做的目的是如果以后想还原回来比较方便，只需要修改引用就行。</p>
<p>接下来我们修改casLoginView.jsp页面：</p>
<p>修改的要求是：需要保留登陆form表单（但可以修改样式，虽然表单标签是带前缀的，但和普通html标签一样修改其样式，也可以将所有的信息输出删除 如&lt;spring:message code=”screen.welcome.label.netid.accesskey” var=”userNameAccessKey” /&gt;）但必须保留保单中的用户名、密码输入框，确认按钮，而且最好复制其标签，修改其class属性来修改样式.</p>
<p>__参考资料<br><em><a href="http://www.liferay.com/community/wiki/-/wiki/Main/JBoss+AS7+tips#section-JBoss+AS7+tips-Installing+cas-web" target="_blank" rel="noopener">Jboss as 7 wiki - Installing cas-web</a>
</em><a href="http://wiki.bsdn.org/pages/viewpage.action?pageId=2326779" target="_blank" rel="noopener">WebLogic上CAS服务器搭建</a><br><em><a href="http://wiki.bsdn.org/pages/viewpage.action?pageId=2326775" target="_blank" rel="noopener">WebSphere上搭建CAS Server</a>
</em><a href="http://www.coin163.com/java/cas/cas.html" target="_blank" rel="noopener">CAS实现单点登陆的原理</a><br><em><a href="http://blog.csdn.net/frinder/article/details/7969925" target="_blank" rel="noopener">CAS单点登陆(SSO)完整教程</a>
</em><a href="http://blog.csdn.net/alonesword/article/details/17692269" target="_blank" rel="noopener">修改cas登陆页面-服务器端</a><br>*<a href="http://exceptioneye.iteye.com/blog/1886131" target="_blank" rel="noopener">单点登录 - CAS【四】获取更全面的用户信息</a></p>
</connector><link href="/css/prism-dark.css" rel="stylesheet">
    
  </div>
</article>

</div>


  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">您得支持,是我前进的动力.</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/css/qr-donate.jpg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>




  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              rel="noopener noreferrer"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
  <section class="duoshuo-comments">

    <!-- UY BEGIN -->
    <div id="uyan_frame"></div>
    <script async type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2144561">
    <!-- UY END -->
  </section>

  <script type="text/javascript">
	var uyan_config = {
	     'su':"CAS单点登陆(SSO)开发指南" 
	};
	</script>



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
